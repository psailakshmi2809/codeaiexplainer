FROM node:16.15.0-buster-slim

# Set working directory
WORKDIR /app

# Copy package files
COPY node/ezpay-api-svc/package.json ./node/ezpay-api-svc/
COPY node/ezpay-api-svc/yarn.lock ./node/ezpay-api-svc/

# Install system packages and PowerShell
RUN apt-get update && \
    apt-get install -y build-essential python3 wget apt-transport-https software-properties-common && \
    wget -q https://packages.microsoft.com/config/debian/10/packages-microsoft-prod.deb && \
    dpkg -i packages-microsoft-prod.deb && \
    apt-get update && \
    apt-get install -y powershell && \
    rm -rf /var/lib/apt/lists/*

# Install Node packages
WORKDIR /app/node/ezpay-api-svc
RUN yarn install --ignore-engines

# Debug: check if grpc-tools binaries exist
RUN ls -la node_modules/grpc-tools/bin || echo "grpc-tools binaries not found"

# Only run chmod if the files exist
RUN [ -f node_modules/grpc-tools/bin/protoc ] && chmod +x node_modules/grpc-tools/bin/protoc || echo "protoc not found"
RUN [ -f node_modules/grpc-tools/bin/grpc_node_plugin ] && chmod +x node_modules/grpc-tools/bin/grpc_node_plugin || echo "grpc_node_plugin not found"

# Copy source files
COPY protos /app/protos
COPY node/ezpay-api-svc /app/node/ezpay-api-svc

# Set working directory again after copy
WORKDIR /app/node/ezpay-api-svc

# Generate proto files
RUN yarn grpc:gen-js-docker && yarn grpc:gen-ts-docker

# Run the service
RUN yarn start
